#!/usr/bin/env node
/**
 * Generate examplesBinaryAssets.ts from image files.
 *
 * Usage: node scripts/generate-example-assets.js
 *
 * Reads images from public/examples-images/ and generates a TypeScript file
 * with base64-encoded data that can be embedded in the examples filesystem.
 */

const fs = require('fs')
const path = require('path')

// Source directory containing images
const SOURCE_DIR = path.join(__dirname, '..', 'public', 'examples-images')

// Output TypeScript file
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'hooks', 'examplesBinaryAssets.ts')

// Map of source filenames to their paths in the examples filesystem
const IMAGE_MAPPINGS = {
  'blue_ship.png': 'canvas/images/blue_ship.png',
  'enemy_ship.png': 'canvas/images/enemy_ship.png',
  'meteor.png': 'canvas/images/meteor.png',
  'laser.png': 'canvas/images/laser.png',
}

function generateAssets() {
  const assets = {}

  for (const [sourceFile, targetPath] of Object.entries(IMAGE_MAPPINGS)) {
    const sourcePath = path.join(SOURCE_DIR, sourceFile)

    if (!fs.existsSync(sourcePath)) {
      console.error(`Warning: ${sourcePath} not found, skipping`)
      continue
    }

    const data = fs.readFileSync(sourcePath)
    const base64 = data.toString('base64')
    assets[targetPath] = base64

    console.log(`  ${sourceFile} -> ${targetPath} (${data.length} bytes)`)
  }

  return assets
}

function generateTypeScript(assets) {
  const lines = [
    '/**',
    ' * Binary assets for examples workspace.',
    ' * Auto-generated by scripts/generate-example-assets.js',
    ' * DO NOT EDIT MANUALLY',
    ' */',
    '',
    '/**',
    ' * Base64-encoded binary assets.',
    ' * Keys are paths within the examples filesystem.',
    ' */',
    'export const EXAMPLES_BINARY_BASE64: Record<string, string> = {',
  ]

  for (const [path, base64] of Object.entries(assets)) {
    lines.push(`  '${path}': '${base64}',`)
  }

  lines.push('};')
  lines.push('')
  lines.push('/**')
  lines.push(' * Decode base64 assets to Uint8Array for filesystem use.')
  lines.push(' */')
  lines.push('export function getExamplesBinaryContent(): Record<string, Uint8Array> {')
  lines.push('  const result: Record<string, Uint8Array> = {}')
  lines.push('  for (const [path, base64] of Object.entries(EXAMPLES_BINARY_BASE64)) {')
  lines.push('    const binary = atob(base64)')
  lines.push('    const bytes = new Uint8Array(binary.length)')
  lines.push('    for (let i = 0; i < binary.length; i++) {')
  lines.push('      bytes[i] = binary.charCodeAt(i)')
  lines.push('    }')
  lines.push('    result[path] = bytes')
  lines.push('  }')
  lines.push('  return result')
  lines.push('}')
  lines.push('')

  return lines.join('\n')
}

function main() {
  console.log('Generating example binary assets...')
  console.log(`Source: ${SOURCE_DIR}`)
  console.log(`Output: ${OUTPUT_FILE}`)
  console.log('')

  const assets = generateAssets()

  if (Object.keys(assets).length === 0) {
    console.error('No assets found!')
    process.exit(1)
  }

  const typescript = generateTypeScript(assets)
  fs.writeFileSync(OUTPUT_FILE, typescript)

  console.log('')
  console.log(`Generated ${OUTPUT_FILE}`)
  console.log(`Total assets: ${Object.keys(assets).length}`)
}

main()
