name: E2E Verification

on:
  issue_comment:
    types: [created]

jobs:
  verify:
    # Triggered by /e2e-verified comment on a PR
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/e2e-verified')
    runs-on: ubuntu-latest

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('sha', pr.data.head.sha);

      - name: Mark E2E as verified
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'success',
              context: 'E2E Tests',
              description: `Verified locally by @${commenter}`,
            });
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1',
            });
