name: Build Electron App

on:
  push:
    branches: [main, 'epic-**']
    paths:
      - 'packages/electron-wrapper/**'
      - '.github/workflows/electron-build.yml'
  pull_request:
    branches: [main, 'epic-**']
    paths:
      - 'packages/electron-wrapper/**'
      - '.github/workflows/electron-build.yml'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts
        working-directory: packages/electron-wrapper

      - name: Build portable exe for Windows
        run: npm run build:win
        working-directory: packages/electron-wrapper

      - name: Rename artifact
        run: |
          cd packages/electron-wrapper/dist
          for file in *.exe; do
            mv "$file" "AdventuresInLua-portable-windows.exe"
          done
        shell: bash

      - name: Upload Windows portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdventuresInLua-portable-windows
          path: packages/electron-wrapper/dist/AdventuresInLua-portable-windows.exe
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts
        working-directory: packages/electron-wrapper

      - name: Build for macOS ${{ matrix.arch }}
        run: npm run build:mac -- --${{ matrix.arch }}
        working-directory: packages/electron-wrapper

      - name: Ad-hoc sign macOS app
        run: |
          APP_PATH="packages/electron-wrapper/dist/mac-${{ matrix.arch }}/Adventures in Lua.app"
          echo "Signing app at: $APP_PATH"
          codesign --deep --force --verbose --sign - "$APP_PATH"

      - name: Create ZIP archive
        run: |
          cd "packages/electron-wrapper/dist/mac-${{ matrix.arch }}"
          zip -r "../AdventuresInLua-portable-macos-${{ matrix.arch }}.zip" "Adventures in Lua.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdventuresInLua-portable-macos-${{ matrix.arch }}
          path: packages/electron-wrapper/dist/AdventuresInLua-portable-macos-${{ matrix.arch }}.zip
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts
        working-directory: packages/electron-wrapper

      - name: Build AppImage for Linux
        run: npm run build:linux
        working-directory: packages/electron-wrapper

      - name: Rename artifact
        run: |
          cd packages/electron-wrapper/dist
          for file in *.AppImage; do
            mv "$file" "AdventuresInLua-portable-linux.AppImage"
          done

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdventuresInLua-portable-linux
          path: packages/electron-wrapper/dist/AdventuresInLua-portable-linux.AppImage
          retention-days: 30

  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./packages/electron-wrapper/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=desktop-v$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Adventures in Lua Desktop ${{ steps.version.outputs.version }}
          body: |
            ## Adventures in Lua Desktop App

            Portable desktop application for Adventures in Lua. No installation required.

            ### Downloads
            - **Windows**: `AdventuresInLua-portable-windows.exe` - Run directly, no install needed
            - **macOS (Intel)**: `AdventuresInLua-portable-macos-x64.zip` - Extract and run
            - **macOS (Apple Silicon)**: `AdventuresInLua-portable-macos-arm64.zip` - Extract and run
            - **Linux**: `AdventuresInLua-portable-linux.AppImage` - Make executable and run

            ### macOS First Launch
            On first launch, macOS may show a security warning for apps from unidentified developers.
            To open the app:
            1. **Right-click** (or Control-click) on "Adventures in Lua.app"
            2. Select **"Open"** from the context menu
            3. Click **"Open"** in the dialog that appears

            After the first launch, you can open the app normally by double-clicking.

            ### Notes
            - This app wraps the hosted web application at https://adventuresinlua.web.app
            - Web updates are automatic - no need to download new versions for content updates
          files: |
            artifacts/AdventuresInLua-portable-windows/AdventuresInLua-portable-windows.exe
            artifacts/AdventuresInLua-portable-macos-x64/AdventuresInLua-portable-macos-x64.zip
            artifacts/AdventuresInLua-portable-macos-arm64/AdventuresInLua-portable-macos-arm64.zip
            artifacts/AdventuresInLua-portable-linux/AdventuresInLua-portable-linux.AppImage
          draft: false
          prerelease: false
          make_latest: true
