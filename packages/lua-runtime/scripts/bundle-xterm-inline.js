#!/usr/bin/env node
/**
 * Bundle xterm.js (terminal emulator) into self-contained JavaScript strings.
 *
 * This script:
 * 1. Reads xterm.js and minifies it with esbuild
 * 2. Reads xterm.css
 * 3. Outputs a TypeScript file with XTERM_INLINE_JS and XTERM_INLINE_CSS exports
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { transformSync } from 'esbuild';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Paths - xterm is installed in root node_modules due to npm workspaces
const XTERM_DIR = join(__dirname, '..', '..', '..', 'node_modules', 'xterm');
const XTERM_JS = join(XTERM_DIR, 'lib', 'xterm.js');
const XTERM_CSS = join(XTERM_DIR, 'css', 'xterm.css');
const OUTPUT_DIR = join(__dirname, '..', 'src');
const OUTPUT_TS = join(OUTPUT_DIR, 'xterm-inline.generated.ts');

function bundleXterm() {
  console.log('Bundling xterm.js for inline exports...');

  // Read xterm JavaScript
  if (!existsSync(XTERM_JS)) {
    throw new Error(`xterm.js not found at ${XTERM_JS}. Run npm install first.`);
  }
  const xtermJsRaw = readFileSync(XTERM_JS, 'utf-8');
  console.log(`  Read xterm.js: ${xtermJsRaw.length} bytes`);

  // Minify with esbuild
  const minified = transformSync(xtermJsRaw, {
    minify: true,
    target: 'es2020',
  });
  const xtermJs = minified.code;
  console.log(`  Minified: ${xtermJs.length} bytes (${Math.round((xtermJs.length / xtermJsRaw.length) * 100)}%)`);

  // Read xterm CSS
  if (!existsSync(XTERM_CSS)) {
    throw new Error(`xterm.css not found at ${XTERM_CSS}`);
  }
  const xtermCss = readFileSync(XTERM_CSS, 'utf-8');
  console.log(`  Read xterm.css: ${xtermCss.length} bytes`);

  // Escape for template literals
  const escapeForTemplate = (code) =>
    code
      .replace(/\\/g, '\\\\')
      .replace(/`/g, '\\`')
      .replace(/\$\{/g, '\\${');

  const escapedJs = escapeForTemplate(xtermJs);
  const escapedCss = escapeForTemplate(xtermCss);

  // Generate TypeScript export
  const tsContent = `/* eslint-disable max-lines */
/**
 * Auto-generated xterm.js bundle with CSS.
 * DO NOT EDIT THIS FILE DIRECTLY.
 *
 * This allows HTML shell exports to work fully offline without CDN dependencies.
 * Run "npm run build:xterm" to regenerate this file.
 */
export const XTERM_INLINE_JS = \`${escapedJs}\`

export const XTERM_INLINE_CSS = \`${escapedCss}\`
`;

  // Ensure output directory exists
  if (!existsSync(OUTPUT_DIR)) {
    mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  writeFileSync(OUTPUT_TS, tsContent);

  const totalSize = xtermJs.length + xtermCss.length;
  console.log(`Generated: xterm-inline.generated.ts (${totalSize} bytes total)`);
  console.log(`  - JS code: ${xtermJs.length} bytes`);
  console.log(`  - CSS: ${xtermCss.length} bytes`);
}

bundleXterm();
