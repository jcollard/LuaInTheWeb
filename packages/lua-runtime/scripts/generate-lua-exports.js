#!/usr/bin/env node
/**
 * Generate TypeScript exports from Lua and JavaScript source files.
 *
 * This script reads .lua files from src/lua/ and .js files from src/audio/
 * and generates corresponding .generated.ts files that export the code as
 * string constants.
 *
 * This allows us to maintain a single source of truth for Lua library
 * documentation and JavaScript inline code while still being able to import
 * them in TypeScript.
 */

import { readFileSync, writeFileSync, readdirSync, existsSync } from 'fs'
import { join, basename, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const LUA_DIR = join(__dirname, '..', 'src', 'lua')
const AUDIO_DIR = join(__dirname, '..', 'src', 'audio')

/**
 * Convert a filename like "canvas.lua" to an export name like "LUA_CANVAS_CODE"
 */
function toLuaExportName(filename) {
  const name = basename(filename, '.lua').toUpperCase()
  return `LUA_${name}_CODE`
}

/**
 * Convert a filename like "audio-inline.js" to an export name like "AUDIO_INLINE_JS"
 */
function toJsExportName(filename) {
  const name = basename(filename, '.js').toUpperCase().replace(/-/g, '_')
  return `${name}_JS`
}

/**
 * Generate a TypeScript file that exports the Lua code as a string constant.
 */
function generateLuaTsExport(luaFilePath) {
  const luaCode = readFileSync(luaFilePath, 'utf-8')
  const filename = basename(luaFilePath)
  const exportName = toLuaExportName(filename)

  // Escape backticks and ${} in the Lua code for template literal
  const escapedCode = luaCode
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${')

  const tsContent = `/* eslint-disable max-lines */
/**
 * Auto-generated from ${filename}
 * DO NOT EDIT THIS FILE DIRECTLY - edit the .lua source instead.
 *
 * Lua code for the ${basename(filename, '.lua')} library.
 * Run "npm run build:lua" to regenerate this file.
 */
export const ${exportName} = \`${escapedCode}\`
`

  const tsFilePath = luaFilePath.replace('.lua', '.generated.ts')
  writeFileSync(tsFilePath, tsContent)
  console.log(`Generated: ${basename(tsFilePath)}`)
}

/**
 * Generate a TypeScript file that exports JavaScript code as a string constant.
 */
function generateJsTsExport(jsFilePath) {
  const jsCode = readFileSync(jsFilePath, 'utf-8')
  const filename = basename(jsFilePath)
  const exportName = toJsExportName(filename)

  // Escape backticks and ${} in the JS code for template literal
  const escapedCode = jsCode
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${')

  const tsContent = `/* eslint-disable max-lines */
/**
 * Auto-generated from ${filename}
 * DO NOT EDIT THIS FILE DIRECTLY - edit the .js source instead.
 *
 * JavaScript code for inline embedding in HTML exports.
 * Run "npm run build:lua" to regenerate this file.
 */
export const ${exportName} = \`${escapedCode}\`
`

  const tsFilePath = jsFilePath.replace('.js', '.generated.ts')
  writeFileSync(tsFilePath, tsContent)
  console.log(`Generated: ${basename(tsFilePath)}`)
}

// Process Lua files
const luaFiles = readdirSync(LUA_DIR).filter((f) => f.endsWith('.lua'))

if (luaFiles.length > 0) {
  console.log(`Generating TypeScript exports from ${luaFiles.length} Lua files...`)
  for (const file of luaFiles) {
    generateLuaTsExport(join(LUA_DIR, file))
  }
}

// Process JavaScript files from audio directory (only *-inline.js files)
if (existsSync(AUDIO_DIR)) {
  const jsFiles = readdirSync(AUDIO_DIR).filter((f) => f.endsWith('-inline.js'))

  if (jsFiles.length > 0) {
    console.log(`Generating TypeScript exports from ${jsFiles.length} JavaScript files...`)
    for (const file of jsFiles) {
      generateJsTsExport(join(AUDIO_DIR, file))
    }
  }
}

console.log('Done!')
