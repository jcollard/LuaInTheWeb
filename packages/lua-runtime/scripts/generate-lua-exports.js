#!/usr/bin/env node
/**
 * Generate TypeScript exports from Lua source files.
 *
 * This script reads .lua files from src/lua/ and generates corresponding
 * .generated.ts files that export the Lua code as string constants.
 *
 * This allows us to maintain a single source of truth for Lua library
 * documentation while still being able to import it in TypeScript.
 */

import { readFileSync, writeFileSync, readdirSync } from 'fs'
import { join, basename, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const LUA_DIR = join(__dirname, '..', 'src', 'lua')

/**
 * Convert a filename like "canvas.lua" to an export name like "LUA_CANVAS_CODE"
 */
function toExportName(filename) {
  const name = basename(filename, '.lua').toUpperCase()
  return `LUA_${name}_CODE`
}

/**
 * Generate a TypeScript file that exports the Lua code as a string constant.
 */
function generateTsExport(luaFilePath) {
  const luaCode = readFileSync(luaFilePath, 'utf-8')
  const filename = basename(luaFilePath)
  const exportName = toExportName(filename)

  // Escape backticks and ${} in the Lua code for template literal
  const escapedCode = luaCode
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${')

  const tsContent = `/**
 * Auto-generated from ${filename}
 * DO NOT EDIT THIS FILE DIRECTLY - edit the .lua source instead.
 *
 * Lua code for the ${basename(filename, '.lua')} library.
 * Run "npm run build:lua" to regenerate this file.
 */
export const ${exportName} = \`${escapedCode}\`
`

  const tsFilePath = luaFilePath.replace('.lua', '.generated.ts')
  writeFileSync(tsFilePath, tsContent)
  console.log(`Generated: ${basename(tsFilePath)}`)
}

// Find all .lua files in the lua directory
const luaFiles = readdirSync(LUA_DIR).filter((f) => f.endsWith('.lua'))

if (luaFiles.length === 0) {
  console.log('No .lua files found in', LUA_DIR)
  process.exit(0)
}

console.log(`Generating TypeScript exports from ${luaFiles.length} Lua files...`)

for (const file of luaFiles) {
  generateTsExport(join(LUA_DIR, file))
}

console.log('Done!')
